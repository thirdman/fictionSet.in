!function(){"use strict";function e(e){var o=Array.prototype.slice.call(arguments,1);return o.forEach(function(o){if(o&&"object"==typeof o)for(var t in o)o.hasOwnProperty(t)&&(e[t]=o[t])}),e}angular.module("myApp.services",["firebase","ngRoute"]).factory("FsAdmin",["$rootScope","$location",function(e,o){return{bookView:function(e,o){}}}]).service("FsGet",["$http","$firebase",function(e,o){var t=new Firebase("https://sweltering-fire-3219.firebaseio.com/");return{getBook:function(e){var o,a=t.child("Books").child(e);return a},getUser:function(e){var o=t.child("users").child(e);return o},getSuggested:function(e){var o=t.child("nominated/Books").child(e);return o},getMessage:function(e){var o=t.child("system/usermessages").child(e);return o},getBook1:function(e){var a=o(t.child("Books").child(e)).$asObject();return a},getUser1:function(e){var a=o(t.child("users").child(e)).$asObject();return a}}}]).service("FsNotifyWithId",["$http","$firebase","FsNotify","FsGet",function(e,o,t,a){var n=new Firebase("https://sweltering-fire-3219.firebaseio.com/");return{bookAdded:function(e,o){var n,s;a.getBook(o).on("value",function(l){s=l.val(),a.getUser(e).on("value",function(a){n=a.val(),n.$id=e,s.$id=o,t.bookAdded(n,s)})})},bookSuggested:function(e,o){var n,s;a.getSuggested(o).on("value",function(l){s=l.val(),console.log(l.val()),a.getUser(e).on("value",function(a){console.log(a.val()),n=a.val(),n.$id=e,s.$id=o,t.bookSuggested(n,s)})})},systemMessage:function(e,o){var n,s;a.getUser(e).on("value",function(l){n=l.val(),console.log(n),a.getMessage(o).on("value",function(a){s=a.val(),console.log(s),console.log(n),n.$id=e,s.$id=o,t.systemMessage(n,s)})})}}}]).service("FsNotify",["$http","$firebase","filterFilter","FsGet",function(e,o,t,a){var n=new Firebase("https://sweltering-fire-3219.firebaseio.com/"),s=o(n.child("places")).$asArray(),l=o(n.child("users")).$asArray(),i=o(n.child("Books")).$asArray(),r=o(n.child("collections")).$asArray(),c=n.child("messages"),d=n.child("/system/adminmessages");return{bookAdded:function(e,o,a){var n=!1;a="undefined"!=typeof a?a:!1;var s=(new Date).valueOf(),i="bookAdded",r="New Book Added",u=o.title+" was added.",g=e.$id;return d.push({messageType:i,title:"A Book was added",messageContent:"'"+o.title+"' was added by "+e.displayName,messageLink:"http://fictionset.in/#/book/"+o.$id,activatorName:e.displayName,activatorId:e.$id,timestamp:s}),l.$loaded().then(function(){var a="";angular.forEach(o.places,function(n){var r=!1,d=!1;console.log("thePlace is:"+n.name);var u=n.geonameId,g=parseFloat(n.countryId);if(console.log(parseFloat(n.geonameId)),console.log(parseFloat(n.countryId)),u==g&&(r=!0,console.log("IT IS A COUNTRY")),console.log("sentcountryid:"+a),console.log("placecountry id:"+parseFloat(n.countryId)),a!=parseFloat(n.countryId)){var m=t(l,{following:g});console.log(m),m.length||console.log("NO ONE IS FOLLOWING "+n.name),angular.forEach(m,function(t){if(t.following[parseFloat(n.countryId)])var a=t.following[parseFloat(n.countryId)].countryId;if(console.log(a),a==parseFloat(n.countryId)){console.log("yep, ets do this"),console.log("notifying a country");var l=t.$id;c.child(l).push({userId:l,messageType:i,title:"New Book Added",messageContent:o.title+" was added, set in "+n.name,messageLink:"http://fictionset.in/#/book/"+o.$id,activatorName:e.displayName,activatorId:e.$id,bookId:o.$id,bookTitle:o.title,coverurl:o.coverurl,locationId:n.geonameId,locationName:n.name,countryId:parseFloat(n.countryId),countryName:n.countryName,followsId:parseFloat(n.countryId),followsName:n.countryName,timestamp:s},function(e){e?(console.log("error: "),console.log(e)):console.log("notified.")})}}),a=parseFloat(n.countryId),d=!0}if(!r){var f=t(l,{following:u});console.log(f),f.length||console.log("NO ONE IS FOLLOWING "+n.name),angular.forEach(f,function(t){console.log(t);var a=t.$id;c.child(a).push({userId:a,messageType:i,title:"New Book Added",messageContent:o.title+" was added, set in "+n.name,messageLink:"http://fictionset.in/#/book/"+o.$id,activatorName:e.displayName,activatorId:e.$id,bookId:o.$id,bookTitle:o.title,coverurl:o.coverurl,locationId:n.geonameId,locationName:n.name,countryId:parseFloat(n.countryId),countryName:n.countryName,followsId:parseFloat(n.geonameId),followsName:n.name,timestamp:s},function(e){e?(console.log("error: "),console.log(e)):console.log("notified.")})})}})}),"Book added: Admin and users notified"},bookSuggested:function(e,o){var a=(new Date).valueOf(),n="bookSuggested",s="New Book Suggested",i=o.title+" was suggested.";return d.push({messageType:n,title:"A Book was suggested",messageContent:"'"+o.title+"' was suggested by "+e.displayName,messageLink:"http://fictionset.in/#/requests/",activatorName:e.displayName,activatorId:e.$id,timestamp:a}),l.$loaded().then(function(){var s="";angular.forEach(o.places,function(i){var r=!1,d=!1;console.log("thePlace is:"+i.name);var u=i.geonameId,g=parseFloat(i.countryId);if(console.log(parseFloat(i.geonameId)),console.log(parseFloat(i.countryId)),u==g&&(r=!0,console.log("IT IS A COUNTRY")),console.log("sentcountryid:"+s),console.log("placecountry id:"+parseFloat(i.countryId)),s!=parseFloat(i.countryId)){var m=t(l,{following:g});console.log(m),m.length||console.log("NO ONE IS FOLLOWING "+i.name),angular.forEach(m,function(t){if(t.following[parseFloat(i.countryId)])var s=t.following[parseFloat(i.countryId)].countryId;if(console.log(s),s==parseFloat(i.countryId)){console.log("yep, ets do this"),console.log("notifying a country");var l=t.$id;c.child(l).push({userId:l,messageType:n,title:"New Book Suggested",messageContent:o.title+" was suggested, set in "+i.name,messageLink:"http://fictionset.in/#/requests/",activatorName:e.displayName,activatorId:e.$id,bookId:o.$id,bookTitle:o.title,coverurl:o.coverurl,locationId:i.geonameId,locationName:i.name,countryId:parseFloat(i.countryId),countryName:i.countryName,followsId:parseFloat(i.countryId),followsName:i.countryName,timestamp:a},function(e){e?(console.log("error: "),console.log(e)):console.log("notified.")})}}),s=parseFloat(i.countryId),d=!0}if(!r){var f=t(l,{following:u});console.log(f),f.length||console.log("NO ONE IS FOLLOWING "+i.name),angular.forEach(f,function(t){console.log(t);var s=t.$id;c.child(s).push({userId:s,messageType:n,title:"New Book Suggested",messageContent:o.title+" was suggested, set in "+i.name,messageLink:"http://fictionset.in/#/requests/",activatorName:e.displayName,activatorId:e.$id,bookId:o.$id,bookTitle:o.title,coverurl:o.coverurl,locationId:i.geonameId,locationName:i.name,countryId:parseFloat(i.countryId),countryName:i.countryName,followsId:parseFloat(i.geonameId),followsName:i.name,timestamp:a},function(e){e?(console.log("error: "),console.log(e)):console.log("notified.")})})}})}),"Book added: Admin and users notified"},systemMessage:function(e,o){var t=(new Date).valueOf(),a="system";return l.$loaded().then(function(){angular.forEach(l,function(e){var n=e.$id;c.child(n).push({userId:n,messageType:a,title:o.title,messageContent:o.messageContent,messageLink:o.messageLink,activatorName:o.authorName,activatorId:o.authorId,timestamp:t},function(e){e?(console.log("error: "),console.log(e)):console.log("notified.")})})}),"System Message Added"}}}])}();
app.controller("BookCtrl",["fsConfig","$scope","$rootScope","Auth","currentUser","$firebase","$firebaseArray","$firebaseObject","$routeParams","$location","$timeout","DataSource","iTunesData","Profile","filterFilter","ngDialog","$log","FsStats","FsGet",function(o,e,l,i,n,c,t,s,a,r,d,u,g,h,p,m,f,v,b){"use strict";e.isLoading=!0,e.auth=i;var k=i.$getAuth();e.authData=k;var A=!1;e.isBookmarking=A,e.hasData=!1,e.isLoadingAmazon=!1,e.noAmazon=!0,e.hasAmazon=!1,e.amazonData="",e.userAaa=!1,e.userRole=0,e.relatedBooks="",e.thereport="",e.bookplaces={};var B;e.placesCount=B;var R="/",y="",C,E,F,w,I,L,U,P,S;e.mapUrlString=y;var D,T,_="",N="",z="",O="",M=!1,j=[],x=[],Y=a.id;e.inCollection=M,e.bookid=Y,e.testContent="ggg",e.collectionFollowing=!1,e.collectionAdded=!1,e.collectionProcessing=!1;var G=!1;e.collectionShowCreate=G;var J={};e.collectionsObj=J;var V=[];e.collectionsArray=V;var q=[],H=new Firebase(o.FIREBASE_URL+"/Books/"+Y);e.book=s(H);var K=s(new Firebase(o.FIREBASE_URL+"/Books/"+Y)),Q=t(new Firebase(o.FIREBASE_URL+"/Books/"));K.$loaded().then(function(){if(e.hasData=!0,e.isLoading=!1,l.pageTitle="Book: "+K.title,console.log("Book Obj is:"),console.log(K),v.addBookView(Y),K.amazon_id.length){var o="http://fictionset.in/admin/amazon/amazon_getBook.php?search="+K.amazon_id;io(o)}if(K.places){var i=[];i=K.places,e.bookPlaces=i;var c=!0,t=0,s="",a=[];angular.forEach(i,function(o){""===N?(_=o.lat,N=o.lat):(o.lat>_&&(_=o.lat),o.lat<N&&(N=o.lat)),""===O?(z=o.lng,O=o.lng):(o.lat>z&&(z=o.lng),o.lat<O&&(O=o.lng));var l="pin-m-library+222("+o.lng+","+o.lat+")";"/"===R?R+=l:R=R+","+l,s!==o.countryId&&(console.log("Locations is not from the same country"),s=o.countryId,a.push(o)),c&&(D=o.lat,T=o.lng,e.bkLng=T,e.bkLat=D,1===t&&(c=!1)),t+=1}),console.log("theCount length: "),console.log(t),B=t,e.placesCount=t,Q.$loaded().then(function(){angular.forEach(a,function(o){ao(o.countryId);var l=p(Q,o.countryId);console.log(l),o.countryBooks=l,x.push(o),e.relatedBooks=x})})}else e.bkLng="100",e.bkLat="0";K.apple_id?(console.log("Yo, apple id already here"),S=K.apple_id,co(S)):K.isbn13&&(console.log("Yo, isbn13 in the house!"),S=K.isbn13,no(S)),lo(n)});var W=t(new Firebase(o.FIREBASE_URL+"/collections/"));if(e.arrCollections=W,W.$loaded().then(function(){}),k){var X={},Z=b.getUser1(k.uid);Z.$loaded().then(function(){e.profile=Z,Z.collections?(console.log("profile collections:"),console.log(Z.collections),X=Z.collections):console.log("No profile collections:")});var oo=b.getRole(k.uid);oo.$loaded().then(function(){console.log(oo);var o=oo.$value>50;e.userRole=oo.$value,e.userAaa=o,console.log("$scope.userRole is "+e.userRole),console.log("$scope.userAaa is "+e.userAaa)})["catch"](function(o){console.error(o)});var eo=t(new Firebase(o.FIREBASE_URL+"/users/").child(n.uid).child("collections"));eo.$loaded().then(function(){console.log("userCollectionArray length is "+eo.length),e.userCollectionArray=eo});var lo=function(l){A=!0,e.isBookmarking=A;var i=new Firebase(o.FIREBASE_URL+"/users/").child(l.uid);i.child("collections/bookshelf").once("value",function(o){var l=null!==o.val();if(l){var i=[];i=o.val(),e.bookshelf=o.val(),i=p(i,e.book.$id),console.log("userCollection length is: "+i.length),i.length?(console.log("in collection and their collection is"),console.log(i),console.log("adding to sceope"),M=!0,e.inCollection=M):(console.log("not in collection and their collection is"),console.log(i),M=!1,e.inCollection=M)}A=!1,e.isBookmarking=A})}}var io=function(o){e.isLoadingAmazon=!0,C=function(o){var l=o[0];console.log(l),l.ItemAttributes.Title.length?(e.amazonData=l,e.isLoadingAmazon=!1,e.hasAmazon=!0,e.noAmazon=!1):(e.noAmazon=!0,e.isLoadingAmazon=!1)},u.get(o,C)},no=function(o){e.isLoadingApple=!0,g.lookupIsbn(o).then(function(o){if(o.data){console.log("has data"),console.log("take a bite of this lovely apple:"),console.log(o.data);var l=o.data.results[0];e.appleData=l,e.isLoadingApple=!1,e.hasApple=!0,e.noApple=!1}else e.isLoadingApple=!1,e.noApple=!0})},co=function(o){e.isLoadingApple=!0,g.lookupId(o).then(function(o){if(o.data){console.log("has data"),console.log("take a bite of this lovely apple:"),console.log(o.data);var l=o.data.results[0];e.appleData=l,e.isLoadingApple=!1,e.hasApple=!0,e.noApple=!1}else e.isLoadingApple=!1,e.noApple=!0})};e.collectionsAdd=function(l,i,c){A=!0,e.isBookmarking=A;var t=new Firebase(o.FIREBASE_URL).child("users").child(n.uid).child("collections");t.child(c).child("books").child(Y).once("value",function(o){var e=null!==o.val();e?to(n,l,c):so(n,l,c)}),e.isAdding=!0,e.isAdded=!1};var to=function(l,i,n){if(A=!0,console.log(l+i+Y+n),Y){var c=new Firebase(o.FIREBASE_URL).child("users").child(l.uid).child("collections");c.child(n).child("books").child(Y).remove(),M=!1,e.inCollection=M,A=!1}e.isBookmarking=A},so=function(l,i,n){A=!0;var c=(new Date).valueOf();if(Y){var t=new Firebase(o.FIREBASE_URL).child("users").child(l.uid).child("collections");t.child(n).child("books").child(Y).update({bookid:Y,description:K.description,coverUrl:K.coverurl,title:K.title,timestamp:c,addedToCollectionDate:c,addedToCollectionBy:l.uid}),t.child(n).update({timestamp:c,updatedAt:c,updatedBy:l.uid,isPublic:!1}),M=!0,e.inCollection=M,A=!1}e.isBookmarking=A},ao=function(o){var l="http://api.geonames.org/neighboursJSON?&lang=en&style=medium&maxRows=15&type=json&username=thirdman&geonameId="+o;u.get(l,function(o){angular.forEach(o.geonames,function(o){j.push(o),e.neighbourCountries=j}),ro()})},ro=function(){Q.$loaded().then(function(){j.length&&angular.forEach(j,function(o){var l=p(Q,o.countryId);l.length&&(o.countryBooks=l,q.push(o)),e.neighbourRelatedBooks=q})})},uo=new Firebase(o.FIREBASE_URL+"/collections/");uo.once("value",function(o){var l=null!==o.val();e.refCollections=o.val(),l&&console.log(e.refCollections)}),e.showCreateCollection=function(){e.newColl={},w=!1,e.collectionAdded=w,I=!1,e.collectionProcessing=!1,G=!0,e.collectionShowCreate=!0},e.showCollections=function(){G=!1,e.collectionShowCreate=!1},e.createNewCollection=function(l){var i=(new Date).valueOf();if(I=!0,e.collectionProcessing=!0,l.title){l.description||(l.description=""),l.imgUrl||(l.imgUrl=""),l.isPublic||(l.isPublic=!1);var c=o.FIREBASE_URL,t=new Firebase(c).child("collections"),s=new Firebase(c).child("users").child(n.uid).child("collections"),a=t.push({title:l.title,createdBy:n.uid,createdByName:Z.displayName,description:l.description,imgUrl:l.imgUrl,timestamp:i,isPublic:l.isPublic}),r=a.key();s.child(r).set({collectionId:r,title:l.title,createdBy:n.uid,createdByName:Z.displayName,description:l.description,imgUrl:l.imgUrl,timestamp:i,isPublic:l.isPublic}),w=!0,e.collectionAdded=w,I=!1,e.collectionProcessing=!1,G=!1,e.collectionShowCreate=!1}else I=!1,e.collectionProcessing=!1},e.toggleBookInCollection=function(o,e,l){console.log("This is the toggle"),console.log("collectionId: "+o),console.log("collectionsArrayIndex: "+e),console.log("theAction "+l),"remove"===l?F(o,e):"add"===l&&E(o,e)},E=function(l){var i=(new Date).valueOf();if(console.log(Z),U=!0,e.bookProcessing=!0,console.log(K),l){var c=o.FIREBASE_URL,t=new Firebase(c).child("collections").child(l),s=new Firebase(c).child("users").child(n.uid).child("collections").child(l);t.child("books").child(Y).update({bookid:K.$id,title:K.title,description:K.description,coverUrl:K.coverurl,addedToCollectionByName:Z.displayName,addedToCollectionById:n.uid,addedToCollectionDate:i}),s.child("books").child(Y).update({bookid:K.$id,title:K.title,description:K.description,coverUrl:K.coverurl,addedToCollectionByName:Z.displayName,addedToCollectionById:n.uid,addedToCollectionDate:i}),U=!1,e.bookProcessing=!1}},F=function(l,i){if(console.log("removing book to collection"),U=!0,e.bookProcessing=!0,l){var c=o.FIREBASE_URL,t=new Firebase(c).child("collections").child(l),s=new Firebase(c).child("users").child(n.uid).child("collections").child(l),a=function(o){console.log(o?"Removing failed failed":"Removing succeeded")};t.child("books").child(Y).remove(a),s.child("books").child(Y).remove(a),P=!0,e.collectionsArray[i].hasThisBook=0,console.log(e.collectionsArray[i]),e.bookRemoved=P,U=!1,e.bookProcessing=!1}},e.addBookToCollection=function(l){console.log("adding book to collection"),console.log(l),console.log(Y);var i=(new Date).valueOf();if(console.log(Z),U=!0,e.bookProcessing=!0,console.log(K),l){var c=o.FIREBASE_URL,t=new Firebase(c).child("collections").child(l),s=new Firebase(c).child("users").child(n.uid).child("collections").child(l);t.child("books").child(Y).update({bookid:K.$id,title:K.title,description:K.description,coverUrl:K.coverurl,addedToCollectionByName:Z.displayName,addedToCollectionById:n.uid,addedToCollectionDate:i}),s.child("books").child(Y).update({bookid:K.$id,title:K.title,description:K.description,coverUrl:K.coverurl,addedToCollectionByName:Z.displayName,addedToCollectionById:n.uid,addedToCollectionDate:i}),U=!1,e.bookProcessing=!1,console.log(V)}},e.removeBookFromCollection=function(l){console.log("removing book to collection");var i=e.collectionsArray;if(U=!0,e.bookProcessing=!0,l){var c=o.FIREBASE_URL,t=new Firebase(c).child("collections").child(l),s=new Firebase(c).child("users").child(n.uid).child("collections").child(l),a=function(o){console.log(o?"Removing failed failed":"Removing succeeded")};t.child("books").child(Y).remove(a),s.child("books").child(Y).remove(a),P=!0,e.bookRemoved=P,U=!1,e.bookProcessing=!1,console.log(i)}},e.clickToOpen=function(){w=!1;var l;e.collectionAdded=w,I=!1,e.collectionProcessing=!1;var i=[],c=t(new Firebase(o.FIREBASE_URL+"/users/").child(n.uid).child("collections"));c.$loaded().then(function(){e.collArr=c,angular.forEach(c,function(o){L=[],o.books?(l=p(o.books,{bookid:Y}).length,angular.forEach(o.books,function(o){L.push(o)})):l=!1,o.bookCount=L.length,o.hasThisBook=l,i.push(o)}),e.collectionsArray=i}),m.open({plain:!1,template:"views/dialogs/dialogCollections.html",scope:e})},e.submitReport=function(l){var i,n,c;e.isError=!1,e.errorMessage="",e.reportProcessing=!0;var t=!0,s=!1;if(console.log(l),console.log(e.thereport),!l.content)return void(e.reportProcessing=!1);if(Z){i="Edit",n=(new Date).valueOf();var a=new Firebase(o.FIREBASE_URL),r=a.child("system/adminmessages");r.push({title:"Suggestion/Error report for "+K.title,authorName:Z.displayName,authorId:Z.$id,messageType:i,messageLink:"http://fictionset.in/#/book/"+Y,timestamp:n,messageContent:l.content},function(o){return o?(console.log(o),c=!0,e.errorMessage.title="Error",e.errorMessage.message=o,t=!1,s=!1,e.reportDone=!1,void(e.reportProcessing=!1)):(t=!1,s=!0,e.reportProcessing=!1,e.reportDone=!0,e.$apply(),void 0)})}else c=!0,e.isError=c,e.errorMessage.title="No User Defined",e.errorMessage.message="User name and email must be defined (on your account page) before submitting content",e.reportDone=!1,e.reportProcessing=!1},e.dialogReport=function(){e.reportProcessing=!1,e.reportDone=!1,e.isError=!1,m.open({plain:!1,template:"views/dialogs/dialogReport.html",scope:e})}}]);
//# sourceMappingURL=./ctrlBook-min.js.map
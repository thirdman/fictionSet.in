app.controller("BookCtrl",["fsConfig","$scope","$rootScope","Auth","currentUser","$firebaseArray","$firebaseObject","$routeParams","$location","$timeout","DataSource","iTunesData","Profile","filterFilter","ngDialog","$log","FsStats","FsGet",function(o,e,l,i,n,c,t,s,a,r,d,u,g,h,p,m,v,f){"use strict";e.isLoading=!0,e.auth=i;var b=i.$getAuth();e.authData=b;var k=!1;e.isBookmarking=k,e.hasData=!1,e.isLoadingAmazon=!1,e.noAmazon=!0,e.hasAmazon=!1,e.amazonData="",e.userAaa=!1,e.userRole=0,e.relatedBooks="",e.thereport="",e.bookplaces={};var A;e.placesCount=A;var B="/",R="",y,C,E,F,w,I,L,U,P;e.mapUrlString=R;var S,D,T="",_="",N="",z="",O=!1,M=[],j=[],x=s.id;e.inCollection=O,e.bookid=x,e.testContent="ggg",e.collectionFollowing=!1,e.collectionAdded=!1,e.collectionProcessing=!1;var Y=!1;e.collectionShowCreate=Y;var G={};e.collectionsObj=G;var J=[];e.collectionsArray=J;var V=[],q=new Firebase(o.FIREBASE_URL+"/Books/"+x);e.book=t(q);var H=t(new Firebase(o.FIREBASE_URL+"/Books/"+x)),K=c(new Firebase(o.FIREBASE_URL+"/Books/"));H.$loaded().then(function(){if(e.hasData=!0,e.isLoading=!1,l.pageTitle="Book: "+H.title,console.log("Book Obj is:"),console.log(H),v.addBookView(x),H.amazon_id.length){var o="http://fictionset.in/admin/amazon/amazon_getBook.php?search="+H.amazon_id;lo(o)}if(H.places){var i=[];i=H.places,e.bookPlaces=i;var c=!0,t=0,s="",a=[];angular.forEach(i,function(o){""===_?(T=o.lat,_=o.lat):(o.lat>T&&(T=o.lat),o.lat<_&&(_=o.lat)),""===z?(N=o.lng,z=o.lng):(o.lat>N&&(N=o.lng),o.lat<z&&(z=o.lng));var l="pin-m-library+222("+o.lng+","+o.lat+")";"/"===B?B+=l:B=B+","+l,s!==o.countryId&&(console.log("Locations is not from the same country"),s=o.countryId,a.push(o)),c&&(S=o.lat,D=o.lng,e.bkLng=D,e.bkLat=S,1===t&&(c=!1)),t+=1}),console.log("theCount length: "),console.log(t),A=t,e.placesCount=t,K.$loaded().then(function(){angular.forEach(a,function(o){so(o.countryId);var l=h(K,o.countryId);console.log(l),o.countryBooks=l,j.push(o),e.relatedBooks=j})})}else e.bkLng="100",e.bkLat="0";H.apple_id?(console.log("Yo, apple id already here"),P=H.apple_id,no(P)):H.isbn13&&(console.log("Yo, isbn13 in the house!"),P=H.isbn13,io(P)),eo(n)});var Q=c(new Firebase(o.FIREBASE_URL+"/collections/"));if(e.arrCollections=Q,Q.$loaded().then(function(){}),b){var W={},X=f.getUser1(b.uid);X.$loaded().then(function(){e.profile=X,X.collections?(console.log("profile collections:"),console.log(X.collections),W=X.collections):console.log("No profile collections:")});var Z=f.getRole(b.uid);Z.$loaded().then(function(){console.log(Z);var o=Z.$value>50;e.userRole=Z.$value,e.userAaa=o,console.log("$scope.userRole is "+e.userRole),console.log("$scope.userAaa is "+e.userAaa)})["catch"](function(o){console.error(o)});var oo=c(new Firebase(o.FIREBASE_URL+"/users/").child(n.uid).child("collections"));oo.$loaded().then(function(){console.log("userCollectionArray length is "+oo.length),e.userCollectionArray=oo});var eo=function(l){k=!0,e.isBookmarking=k;var i=new Firebase(o.FIREBASE_URL+"/users/").child(l.uid);i.child("collections/bookshelf").once("value",function(o){var l=null!==o.val();if(l){var i=[];i=o.val(),e.bookshelf=o.val(),i=h(i,e.book.$id),console.log("userCollection length is: "+i.length),i.length?(console.log("in collection and their collection is"),console.log(i),console.log("adding to sceope"),O=!0,e.inCollection=O):(console.log("not in collection and their collection is"),console.log(i),O=!1,e.inCollection=O)}k=!1,e.isBookmarking=k})}}var lo=function(o){e.isLoadingAmazon=!0,y=function(o){var l=o[0];console.log(l),l.ItemAttributes.Title.length?(e.amazonData=l,e.isLoadingAmazon=!1,e.hasAmazon=!0,e.noAmazon=!1):(e.noAmazon=!0,e.isLoadingAmazon=!1)},d.get(o,y)},io=function(o){e.isLoadingApple=!0,u.lookupIsbn(o).then(function(o){if(o.data){console.log("has data"),console.log("take a bite of this lovely apple:"),console.log(o.data);var l=o.data.results[0];e.appleData=l,e.isLoadingApple=!1,e.hasApple=!0,e.noApple=!1}else e.isLoadingApple=!1,e.noApple=!0})},no=function(o){e.isLoadingApple=!0,u.lookupId(o).then(function(o){if(o.data){console.log("has data"),console.log("take a bite of this lovely apple:"),console.log(o.data);var l=o.data.results[0];e.appleData=l,e.isLoadingApple=!1,e.hasApple=!0,e.noApple=!1}else e.isLoadingApple=!1,e.noApple=!0})};e.collectionsAdd=function(l,i,c){k=!0,e.isBookmarking=k;var t=new Firebase(o.FIREBASE_URL).child("users").child(n.uid).child("collections");t.child(c).child("books").child(x).once("value",function(o){var e=null!==o.val();e?co(n,l,c):to(n,l,c)}),e.isAdding=!0,e.isAdded=!1};var co=function(l,i,n){if(k=!0,console.log(l+i+x+n),x){var c=new Firebase(o.FIREBASE_URL).child("users").child(l.uid).child("collections");c.child(n).child("books").child(x).remove(),O=!1,e.inCollection=O,k=!1}e.isBookmarking=k},to=function(l,i,n){k=!0;var c=(new Date).valueOf();if(x){var t=new Firebase(o.FIREBASE_URL).child("users").child(l.uid).child("collections");t.child(n).child("books").child(x).update({bookid:x,description:H.description,coverUrl:H.coverurl,title:H.title,timestamp:c,addedToCollectionDate:c,addedToCollectionBy:l.uid}),t.child(n).update({timestamp:c,updatedAt:c,updatedBy:l.uid,isPublic:!1}),O=!0,e.inCollection=O,k=!1}e.isBookmarking=k},so=function(o){var l="http://api.geonames.org/neighboursJSON?&lang=en&style=medium&maxRows=15&type=json&username=thirdman&geonameId="+o;d.get(l,function(o){angular.forEach(o.geonames,function(o){M.push(o),e.neighbourCountries=M}),ao()})},ao=function(){K.$loaded().then(function(){M.length&&angular.forEach(M,function(o){var l=h(K,o.countryId);l.length&&(o.countryBooks=l,V.push(o)),e.neighbourRelatedBooks=V})})},ro=new Firebase(o.FIREBASE_URL+"/collections/");ro.once("value",function(o){var l=null!==o.val();e.refCollections=o.val(),l&&console.log(e.refCollections)}),e.showCreateCollection=function(){e.newColl={},F=!1,e.collectionAdded=F,w=!1,e.collectionProcessing=!1,Y=!0,e.collectionShowCreate=!0},e.showCollections=function(){Y=!1,e.collectionShowCreate=!1},e.createNewCollection=function(l){var i=(new Date).valueOf();if(w=!0,e.collectionProcessing=!0,l.title){l.description||(l.description=""),l.imgUrl||(l.imgUrl=""),l.isPublic||(l.isPublic=!1);var c=o.FIREBASE_URL,t=new Firebase(c).child("collections"),s=new Firebase(c).child("users").child(n.uid).child("collections"),a=t.push({title:l.title,createdBy:n.uid,createdByName:X.displayName,description:l.description,imgUrl:l.imgUrl,timestamp:i,isPublic:l.isPublic}),r=a.key();s.child(r).set({collectionId:r,title:l.title,createdBy:n.uid,createdByName:X.displayName,description:l.description,imgUrl:l.imgUrl,timestamp:i,isPublic:l.isPublic}),F=!0,e.collectionAdded=F,w=!1,e.collectionProcessing=!1,Y=!1,e.collectionShowCreate=!1}else w=!1,e.collectionProcessing=!1},e.toggleBookInCollection=function(o,e,l){console.log("This is the toggle"),console.log("collectionId: "+o),console.log("collectionsArrayIndex: "+e),console.log("theAction "+l),"remove"===l?E(o,e):"add"===l&&C(o,e)},C=function(l){var i=(new Date).valueOf();if(console.log(X),L=!0,e.bookProcessing=!0,console.log(H),l){var c=o.FIREBASE_URL,t=new Firebase(c).child("collections").child(l),s=new Firebase(c).child("users").child(n.uid).child("collections").child(l);t.child("books").child(x).update({bookid:H.$id,title:H.title,description:H.description,coverUrl:H.coverurl,addedToCollectionByName:X.displayName,addedToCollectionById:n.uid,addedToCollectionDate:i}),s.child("books").child(x).update({bookid:H.$id,title:H.title,description:H.description,coverUrl:H.coverurl,addedToCollectionByName:X.displayName,addedToCollectionById:n.uid,addedToCollectionDate:i}),L=!1,e.bookProcessing=!1}},E=function(l,i){if(console.log("removing book to collection"),L=!0,e.bookProcessing=!0,l){var c=o.FIREBASE_URL,t=new Firebase(c).child("collections").child(l),s=new Firebase(c).child("users").child(n.uid).child("collections").child(l),a=function(o){console.log(o?"Removing failed failed":"Removing succeeded")};t.child("books").child(x).remove(a),s.child("books").child(x).remove(a),U=!0,e.collectionsArray[i].hasThisBook=0,console.log(e.collectionsArray[i]),e.bookRemoved=U,L=!1,e.bookProcessing=!1}},e.addBookToCollection=function(l){console.log("adding book to collection"),console.log(l),console.log(x);var i=(new Date).valueOf();if(console.log(X),L=!0,e.bookProcessing=!0,console.log(H),l){var c=o.FIREBASE_URL,t=new Firebase(c).child("collections").child(l),s=new Firebase(c).child("users").child(n.uid).child("collections").child(l);t.child("books").child(x).update({bookid:H.$id,title:H.title,description:H.description,coverUrl:H.coverurl,addedToCollectionByName:X.displayName,addedToCollectionById:n.uid,addedToCollectionDate:i}),s.child("books").child(x).update({bookid:H.$id,title:H.title,description:H.description,coverUrl:H.coverurl,addedToCollectionByName:X.displayName,addedToCollectionById:n.uid,addedToCollectionDate:i}),L=!1,e.bookProcessing=!1,console.log(J)}},e.removeBookFromCollection=function(l){console.log("removing book to collection");var i=e.collectionsArray;if(L=!0,e.bookProcessing=!0,l){var c=o.FIREBASE_URL,t=new Firebase(c).child("collections").child(l),s=new Firebase(c).child("users").child(n.uid).child("collections").child(l),a=function(o){console.log(o?"Removing failed failed":"Removing succeeded")};t.child("books").child(x).remove(a),s.child("books").child(x).remove(a),U=!0,e.bookRemoved=U,L=!1,e.bookProcessing=!1,console.log(i)}},e.clickToOpen=function(){F=!1;var l;e.collectionAdded=F,w=!1,e.collectionProcessing=!1;var i=[],t=c(new Firebase(o.FIREBASE_URL+"/users/").child(n.uid).child("collections"));t.$loaded().then(function(){e.collArr=t,angular.forEach(t,function(o){I=[],o.books?(l=h(o.books,{bookid:x}).length,angular.forEach(o.books,function(o){I.push(o)})):l=!1,o.bookCount=I.length,o.hasThisBook=l,i.push(o)}),e.collectionsArray=i}),p.open({plain:!1,template:"views/dialogs/dialogCollections.html",scope:e})},e.submitReport=function(l){var i,n,c;e.isError=!1,e.errorMessage="",e.reportProcessing=!0;var t=!0,s=!1;if(console.log(l),console.log(e.thereport),!l.content)return void(e.reportProcessing=!1);if(X){i="Edit",n=(new Date).valueOf();var a=new Firebase(o.FIREBASE_URL),r=a.child("system/adminmessages");r.push({title:"Suggestion/Error report for "+H.title,authorName:X.displayName,authorId:X.$id,messageType:i,messageLink:"http://fictionset.in/#/book/"+x,timestamp:n,messageContent:l.content},function(o){return o?(console.log(o),c=!0,e.errorMessage.title="Error",e.errorMessage.message=o,t=!1,s=!1,e.reportDone=!1,void(e.reportProcessing=!1)):(t=!1,s=!0,e.reportProcessing=!1,e.reportDone=!0,e.$apply(),void 0)})}else c=!0,e.isError=c,e.errorMessage.title="No User Defined",e.errorMessage.message="User name and email must be defined (on your account page) before submitting content",e.reportDone=!1,e.reportProcessing=!1},e.dialogReport=function(){e.reportProcessing=!1,e.reportDone=!1,e.isError=!1,p.open({plain:!1,template:"views/dialogs/dialogReport.html",scope:e})}}]);
//# sourceMappingURL=./ctrlBook-min.js.map